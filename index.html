<!DOCTYPE html><html class="default"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>jamalta-oidc-client</title><meta name="description" content="Documentation for jamalta-oidc-client"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="assets/style.css"/><link rel="stylesheet" href="assets/highlight.css"/><script async src="assets/search.js" id="search-script"></script></head><body><script>document.body.classList.add(localStorage.getItem("tsd-theme") || "os")</script><header><div class="tsd-page-toolbar"><div class="container"><div class="table-wrap"><div class="table-cell" id="tsd-search" data-base="."><div class="field"><label for="tsd-search-field" class="tsd-widget search no-caption">Search</label><input type="text" id="tsd-search-field"/></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="index.html" class="title">jamalta-oidc-client</a></div><div class="table-cell" id="tsd-widgets"><div id="tsd-filter"><a href="#" class="tsd-widget options no-caption" data-toggle="options">Options</a><div class="tsd-filter-group"><div class="tsd-select" id="tsd-filter-visibility"><span class="tsd-select-label">All</span><ul class="tsd-select-list"><li data-value="public">Public</li><li data-value="protected">Public/Protected</li><li data-value="private" class="selected">All</li></ul></div> <input type="checkbox" id="tsd-filter-inherited" checked/><label class="tsd-widget" for="tsd-filter-inherited">Inherited</label><input type="checkbox" id="tsd-filter-externals" checked/><label class="tsd-widget" for="tsd-filter-externals">Externals</label></div></div><a href="#" class="tsd-widget menu no-caption" data-toggle="menu">Menu</a></div></div></div></div><div class="tsd-page-title"><div class="container"><h1>jamalta-oidc-client </h1></div></div></header><div class="container container-main"><div class="row"><div class="col-8 col-content"><div class="tsd-panel tsd-typography">
<a href="#ja-malta-oidc-relying-party-module" id="ja-malta-oidc-relying-party-module" style="color: inherit; text-decoration: none;">
  <h1>JA Malta OIDC Relying Party Module</h1>
</a>
<p>This module is meant to be used when needing authentication with the JA Malta Platforms.  The authentication, ran under the URI auth.jamalta.org, uses OpenID Connect specs and <a href="https://auth.jamalta.org/.well-known/openid-configuration">discovery url</a>.  </p>
<p><strong>Please note that the authentication and this connector is still in the early alpha testing.  Currently, this module is meant to be used internally until everything is tested</strong>.</p>
<p>This package can technically be used by other OIDC Providers but <strong>this was not tested and no support will be provided</strong>.  </p>
<p>Feel free to open a PR and add/suggest features (no contribution guide yet).</p>

<a href="#features" id="features" style="color: inherit; text-decoration: none;">
  <h2>Features</h2>
</a>
<p>The connector has the following available features:</p>
<ol>
<li>Express Middleware to authenticate a token including a cache that lasts as long as the access-token.</li>
<li>Session continuation after login is hit when token expiry</li>
<li>UserInfo cache, to not constantly call the authentication endpoint everytime user info is needed.</li>
<li>OpenID Discovery Specs</li>
</ol>

<a href="#assumptions" id="assumptions" style="color: inherit; text-decoration: none;">
  <h4>Assumptions</h4>
</a>
<p>Cookie Middleware (such as cookie parser).
ExpressJS being used</p>

<a href="#getting-started" id="getting-started" style="color: inherit; text-decoration: none;">
  <h2>Getting Started</h2>
</a>
<p>Getting started is pretty easy.  </p>

<a href="#creating-the-issuer" id="creating-the-issuer" style="color: inherit; text-decoration: none;">
  <h4>Creating the issuer</h4>
</a>
<pre><code class="language-js"><span class="hl-0">let</span><span class="hl-1"> </span><span class="hl-2">issuer</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-3">JAMaltaIssuer</span><span class="hl-1">(</span><span class="hl-2">clientId</span><span class="hl-1">, </span><span class="hl-2">clientSecret</span><span class="hl-1">, </span><span class="hl-2">redirectUris</span><span class="hl-1">, </span><span class="hl-2">responseTypes</span><span class="hl-1">, </span><span class="hl-2">scopes</span><span class="hl-1">);</span>
</code></pre>

<a href="#getting-the-login-url" id="getting-the-login-url" style="color: inherit; text-decoration: none;">
  <h4>Getting the login url</h4>
</a>
<p>Once the issuer is created, one can get the authorisation url by doing:</p>
<pre><code class="language-js"><span class="hl-0">let</span><span class="hl-1"> </span><span class="hl-2">url</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-2">issuer</span><span class="hl-1">.</span><span class="hl-2">authorisationUrl</span><span class="hl-1">;</span>
</code></pre>

<a href="#login-callback" id="login-callback" style="color: inherit; text-decoration: none;">
  <h4>Login Callback</h4>
</a>
<p>From there onwards, create an express route with the callback and <strong>implement the callback middleware</strong>.  The callback middleware creates a cookie on the frontend which can be read by the authentication middleware.  The callback middleware also gets the cookie &quot;before-callback-location&quot;, which stores the original location to redirect the user to their original location.  This feature can be disabled by setting the useRedirect parameter to false.</p>
<pre><code class="language-js"><span class="hl-2">expressApp</span><span class="hl-1">.</span><span class="hl-3">get</span><span class="hl-1">(</span><span class="hl-5">&quot;/callback&quot;</span><span class="hl-1">, </span><span class="hl-3">callbackMiddleware</span><span class="hl-1">(</span><span class="hl-2">issuer</span><span class="hl-1">, </span><span class="hl-0">true</span><span class="hl-1">), (</span><span class="hl-2">req</span><span class="hl-1">, </span><span class="hl-2">res</span><span class="hl-1">) </span><span class="hl-0">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-6">//your code here</span><br/><span class="hl-1">    </span><span class="hl-2">res</span><span class="hl-1">.</span><span class="hl-3">sendStatus</span><span class="hl-1">(</span><span class="hl-7">200</span><span class="hl-1">);</span><br/><span class="hl-1">});</span>
</code></pre>

<a href="#authentication-middleware" id="authentication-middleware" style="color: inherit; text-decoration: none;">
  <h4>Authentication Middleware</h4>
</a>
<p>After initial authentication is done, the issuer does everything for you using the authentication middleware.  In the case that the token is invalid, the user gets redirected to the login page and a cookie is created called &quot;before-callback-location&quot; so the backend knows where to redirect the user to.</p>
<pre><code class="language-js"><span class="hl-2">expressApp</span><span class="hl-1">.</span><span class="hl-3">get</span><span class="hl-1">(</span><span class="hl-5">&quot;/your-endpoint&quot;</span><span class="hl-1">, </span><span class="hl-3">authenticate</span><span class="hl-1">(</span><span class="hl-2">issuer</span><span class="hl-1">), (</span><span class="hl-2">req</span><span class="hl-1">, </span><span class="hl-2">res</span><span class="hl-1">) </span><span class="hl-0">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">let</span><span class="hl-1"> </span><span class="hl-2">userinfo</span><span class="hl-1"> = </span><span class="hl-2">req</span><span class="hl-1">.</span><span class="hl-2">jaUserInfo</span><span class="hl-1">;</span><br/><span class="hl-1">    </span><span class="hl-2">res</span><span class="hl-1">.</span><span class="hl-3">sendStatus</span><span class="hl-1">(</span><span class="hl-7">200</span><span class="hl-1">);</span><br/><span class="hl-1">})</span>
</code></pre>
<p>The user info is then stored into the request as seen above, and can be used in any way needed.</p>

<a href="#logout" id="logout" style="color: inherit; text-decoration: none;">
  <h4>Logout</h4>
</a>
<p>The issuer also provides the functionality to logout easily by doing <code>let url = await issuer.getLogoutUrl(token);</code>  The logout middleware is used to clear the token, and it&#39;s related user information from the cache, however, this is optional, <strong>considering you do the steps yourself</strong>.  Not clearing the cache will result in the user seemingly staying authenticated until cache expires.</p>
<pre><code class="language-js"><span class="hl-2">expressApp</span><span class="hl-1">.</span><span class="hl-3">get</span><span class="hl-1">(</span><span class="hl-5">&quot;/logout&quot;</span><span class="hl-1">, </span><span class="hl-3">authenticate</span><span class="hl-1">(</span><span class="hl-2">issuer</span><span class="hl-1">), </span><span class="hl-3">logoutMiddleware</span><span class="hl-1">(</span><span class="hl-2">issuer</span><span class="hl-1">), (</span><span class="hl-2">req</span><span class="hl-1">, </span><span class="hl-2">res</span><span class="hl-1">) </span><span class="hl-0">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">   </span><span class="hl-2">issuer</span><span class="hl-1">.</span><span class="hl-3">getLogoutUrl</span><span class="hl-1">(</span><span class="hl-2">req</span><span class="hl-1">.</span><span class="hl-2">tokenCode</span><span class="hl-1">).</span><span class="hl-3">then</span><span class="hl-1">(</span><span class="hl-2">value</span><span class="hl-1"> </span><span class="hl-0">=&gt;</span><span class="hl-1"> </span><span class="hl-2">res</span><span class="hl-1">.</span><span class="hl-3">redirect</span><span class="hl-1">(</span><span class="hl-2">value</span><span class="hl-1">));</span><br/><span class="hl-1">})</span>
</code></pre>

<a href="#developer-features" id="developer-features" style="color: inherit; text-decoration: none;">
  <h2>Developer Features</h2>
</a>

<a href="#custom-issuer-url" id="custom-issuer-url" style="color: inherit; text-decoration: none;">
  <h3>Custom Issuer URL</h3>
</a>
<p>In the case that you are developing onto the OIDC Relay, and want to use a custom issuer URL, you can set the environment variable <code>CUSTOM_ISSUER_URL</code> which forces auto-discovery and endpoint binding to that OIDC Provider, <strong>assuming OIDC discovery is enabled on the OIDC Provider</strong>. </p>
</div></div><div class="col-4 col-menu menu-sticky-wrap menu-highlight"><nav class="tsd-navigation primary"><ul><li class="current"><a href="modules.html">Exports</a></li></ul></nav><nav class="tsd-navigation secondary menu-sticky"><ul><li class="tsd-kind-class"><a href="classes/JAMaltaIssuer.html" class="tsd-kind-icon">JAMalta<wbr/>Issuer</a></li><li class="tsd-kind-interface"><a href="interfaces/UserInfo.html" class="tsd-kind-icon">User<wbr/>Info</a></li><li class="tsd-kind-type-alias"><a href="modules.html#IssuerOptions" class="tsd-kind-icon">Issuer<wbr/>Options</a></li><li class="tsd-kind-function"><a href="modules.html#authenticate" class="tsd-kind-icon">authenticate</a></li><li class="tsd-kind-function"><a href="modules.html#callbackMiddleware" class="tsd-kind-icon">callback<wbr/>Middleware</a></li><li class="tsd-kind-function"><a href="modules.html#logoutMiddleware" class="tsd-kind-icon">logout<wbr/>Middleware</a></li></ul></nav></div></div></div><footer class="with-border-bottom"><div class="container"><h2>Legend</h2><div class="tsd-legend-group"><ul class="tsd-legend"><li class="tsd-kind-constructor tsd-parent-kind-class"><span class="tsd-kind-icon">Constructor</span></li><li class="tsd-kind-property tsd-parent-kind-class"><span class="tsd-kind-icon">Property</span></li><li class="tsd-kind-method tsd-parent-kind-class"><span class="tsd-kind-icon">Method</span></li></ul><ul class="tsd-legend"><li class="tsd-kind-property tsd-parent-kind-class tsd-is-private"><span class="tsd-kind-icon">Private property</span></li><li class="tsd-kind-method tsd-parent-kind-class tsd-is-private"><span class="tsd-kind-icon">Private method</span></li></ul><ul class="tsd-legend"><li class="tsd-kind-property tsd-parent-kind-interface"><span class="tsd-kind-icon">Property</span></li></ul></div><h2>Settings</h2><p>Theme <select id="theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></p></div></footer><div class="container tsd-generator"><p>Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></div><div class="overlay"></div><script src="assets/main.js"></script></body></html>